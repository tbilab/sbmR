<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agglomerative Merging • sbmr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Agglomerative Merging">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sbmr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/agglomerative_merging.html">Agglomerative Merging</a>
    </li>
    <li>
      <a href="../articles/bipartite_networks.html">bipartite_networks</a>
    </li>
    <li>
      <a href="../articles/sampling_from_posterior.html">Sampling From Posterior</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tbilab/sbmr">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Agglomerative Merging</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tbilab/sbmr/blob/master/vignettes/agglomerative_merging.Rmd"><code>vignettes/agglomerative_merging.Rmd</code></a></small>
      <div class="hidden name"><code>agglomerative_merging.Rmd</code></div>

    </div>

    
    
<p>One technique of finding the optimal number of clusters/ best partitioning is using the efficient agglomerative merging algorithm. This is typically used to find the initial state for MCMC chains but can stand on its own as a clustering method.</p>
<p>Agglomerative merging can be acomplished with the SBM class using the functions <code><a href="../reference/collapse_blocks.html">collapse_blocks()</a></code> and <code>collapse_runs()</code>. <code><a href="../reference/collapse_blocks.html">collapse_blocks()</a></code> runs a single agglomerative merge step from one group per node all the way down to your desired number of groups and <code>collapse_runs()</code> repeats this process for a range of groups.</p>
<p>Before we look at using both we need to setup some data to cluster.</p>
<div id="setup" class="section level2">
<h2 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h2>
<p>First we load the <code>sbmr</code> package along with the <code>tidyverse</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(sbmr)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span></code></pre></div>
<div id="data" class="section level3">
<h3 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h3>
<p>The data we are using will come from the included simulation function, <code><a href="../reference/sim_basic_block_network.html">sim_basic_block_network()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">42</span>) <span class="co"># seed for reproducability</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>n_blocks &lt;-<span class="st"> </span><span class="dv">3</span>    <span class="co"># Four total groups</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>group_size &lt;-<span class="st"> </span><span class="dv">40</span> <span class="co"># W/ 50 nodes in each</span></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a>network &lt;-<span class="st"> </span><span class="kw"><a href="../reference/sim_basic_block_network.html">sim_basic_block_network</a></span>(</span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="dt">n_blocks =</span> n_blocks,     </span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="dt">n_nodes_per_block =</span> group_size,  </span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="dt">return_edge_propensities =</span> <span class="ot">TRUE</span>,</span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="dt">random_seed =</span> <span class="dv">42</span> <span class="co"># This is the internal model seed (not same as set.seed())</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>)</span></code></pre></div>
<p>We can investigate the simulated network’s true block structure by visualizing the edge propensities between the groups.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>network<span class="op">$</span>edge_propensities <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> block_<span class="dv">1</span>, <span class="dt">y =</span> block_<span class="dv">2</span>)) <span class="op">+</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html">geom_tile</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">fill =</span> propensity))</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/visualize_propensities-1.png" width="576"></p>
<p>We can also visualise the simulated data directly using the <code><a href="../reference/visualize_network.html">visualize_network()</a></code> function.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw"><a href="../reference/visualize_network.html">visualize_network</a></span>(network)</span></code></pre></div>
</div>
</div>
<div id="single-merge-run" class="section level2">
<h2 class="hasAnchor">
<a href="#single-merge-run" class="anchor"></a>Single merge run</h2>
<p>First we will demonstrate agglomerative merging using the single merge step function: <code><a href="../reference/collapse_blocks.html">collapse_blocks()</a></code>.</p>
<p>There are a few important input parameters we need to consider:</p>
<ul>
<li>
<code>sigma</code>: Controls the rate of collapse. At each step of the collapsing the model will try and remove <code>current_num_nodes(1 - 1/sigma)</code> nodes from the model. So a larger sigma means a faster collapse rate.</li>
<li>
<code>desired_n_blocks</code>: How many groups should this given merge drop down to. If the network has more than one node type this number is multiplied by the total number of types.</li>
<li>
<code>report_all_steps</code>: Should the model state be provided for every merge step or just the final one? If collapsing is being used to infer hierarcichal structure in data or inspection is desired this should be set to <code>TRUE</code>, otherwise it will slow down collapsing due to increased data transfer.</li>
<li>
<code>greedy</code>: Should every possible group merger be considered? If <code>FALSE</code>, candidates for mergers are drawn by similarity in edges (just as MCMC move proposals are). This may lead the model to local minimums by always pursuing best possible merges.</li>
<li>
<code>num_block_proposals</code>: If <code>greedy = FALSE</code>, this parameter controls how many merger proposals are drawn for each group in the model. A larger number will increase the exploration of merge potentials but may lead the model to local minimums for the same reason greedy mode does.</li>
<li>
<code>num_mcmc_sweeps</code>: How many MCMC sweeps the model does at each agglomerative merge step. This allows the model to allow nodes to find their most natural resting place in a given collapsed state. Larger values will slow down runtime but can potentially lead for more stable results.</li>
</ul>
<div id="performing-a-single-merge-with-1-group-per-merge" class="section level3">
<h3 class="hasAnchor">
<a href="#performing-a-single-merge-with-1-group-per-merge" class="anchor"></a>Performing a single merge with 1 group per merge</h3>
<p>To perform the complete merge we put our <code>sigma &lt; 1</code> and our <code>num_mcmc_sweeps = 0</code>. In addition we return all the steps so we can look at the progress of the model as it collapses.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>network &lt;-<span class="st"> </span>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="st">  </span><span class="kw"><a href="../reference/collapse_blocks.html">collapse_blocks</a></span>(<span class="dt">sigma =</span> <span class="fl">0.9</span>, <span class="dt">report_all_steps =</span> <span class="ot">TRUE</span>)</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">  </span><span class="kw"><a href="../reference/get_collapse_results.html">get_collapse_results</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>()</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#&gt;   n_blocks entropy_delta  entropy merges</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="co">#&gt; 1      119      12.97978 3541.393   1, 2</span></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">#&gt; 2      118      14.52065 3555.913   1, 2</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="co">#&gt; 3      117      13.13379 3569.047   1, 2</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="co">#&gt; 4      116      15.23474 3584.282   1, 2</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="co">#&gt; 5      115      15.53421 3599.816   1, 2</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="co">#&gt; 6      114      15.84546 3615.661   1, 2</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="co">#&gt;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          state</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="co">#&gt; 1 g1_1, g1_2, g1_3, g1_4, g1_5, g1_6, g1_7, g1_8, g1_9, g1_10, g1_11, g1_12, g1_13, g1_14, g1_15, g1_16, g1_17, g1_18, g1_19, g1_20, g1_21, g1_22, g1_23, g1_24, g1_25, g1_26, g1_27, g1_28, g1_29, g1_30, g1_31, g1_32, g1_33, g1_34, g1_35, g1_36, g1_37, g1_38, g1_39, g1_40, g2_1, g2_2, g2_3, g2_4, g2_5, g2_6, g2_7, g2_8, g2_9, g2_10, g2_11, g2_12, g2_13, g2_14, g2_15, g2_16, g2_17, g2_18, g2_19, g2_20, g2_21, g2_22, g2_23, g2_24, g2_25, g2_26, g2_27, g2_28, g2_29, g2_30, g2_31, g2_32, g2_33, g2_34, g2_35, g2_36, g2_37, g2_38, g2_39, g2_40, g3_1, g3_2, g3_3, g3_4, g3_5, g3_6, g3_7, g3_8, g3_9, g3_10, g3_11, g3_12, g3_13, g3_14, g3_15, g3_16, g3_17, g3_18, g3_19, g3_20, g3_21, g3_22, g3_23, g3_24, g3_25, g3_26, g3_27, g3_28, g3_29, g3_30, g3_31, g3_32, g3_33, g3_34, g3_35, g3_36, g3_37, g3_38, g3_39, g3_40, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, bl_node_0, bl_node_1, bl_node_2, bl_node_3, bl_node_4, bl_node_5, bl_node_6, bl_node_7, bl_node_8, bl_node_9, bl_node_10, bl_node_11, bl_node_5, bl_node_13, bl_node_14, bl_node_15, bl_node_16, bl_node_17, bl_node_18, bl_node_19, bl_node_20, bl_node_21, bl_node_22, bl_node_23, bl_node_24, bl_node_25, bl_node_26, bl_node_27, bl_node_28, bl_node_29, bl_node_30, bl_node_31, bl_node_32, bl_node_33, bl_node_34, bl_node_35, bl_node_36, bl_node_37, bl_node_38, bl_node_39, bl_node_40, bl_node_41, bl_node_42, bl_node_43, bl_node_44, bl_node_45, bl_node_46, bl_node_47, bl_node_48, bl_node_49, bl_node_50, bl_node_51, bl_node_52, bl_node_53, bl_node_54, bl_node_55, bl_node_56, bl_node_57, bl_node_58, bl_node_59, bl_node_60, bl_node_61, bl_node_62, bl_node_63, bl_node_64, bl_node_65, bl_node_66, bl_node_67, bl_node_68, bl_node_69, bl_node_70, bl_node_71, bl_node_72, bl_node_73, bl_node_74, bl_node_75, bl_node_76, bl_node_77, bl_node_78, bl_node_79, bl_node_80, bl_node_81, bl_node_82, bl_node_83, bl_node_84, bl_node_85, bl_node_86, bl_node_87, bl_node_88, bl_node_89, bl_node_90, bl_node_91, bl_node_92, bl_node_93, bl_node_94, bl_node_95, bl_node_96, bl_node_97, bl_node_98, bl_node_99, bl_node_100, bl_node_101, bl_node_102, bl_node_103, bl_node_104, bl_node_105, bl_node_106, bl_node_107, bl_node_108, bl_node_109, bl_node_110, bl_node_111, bl_node_112, bl_node_113, bl_node_114, bl_node_115, bl_node_116, bl_node_117, bl_node_118, bl_node_119, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="co">#&gt; 2 g1_1, g1_2, g1_3, g1_4, g1_5, g1_6, g1_7, g1_8, g1_9, g1_10, g1_11, g1_12, g1_13, g1_14, g1_15, g1_16, g1_17, g1_18, g1_19, g1_20, g1_21, g1_22, g1_23, g1_24, g1_25, g1_26, g1_27, g1_28, g1_29, g1_30, g1_31, g1_32, g1_33, g1_34, g1_35, g1_36, g1_37, g1_38, g1_39, g1_40, g2_1, g2_2, g2_3, g2_4, g2_5, g2_6, g2_7, g2_8, g2_9, g2_10, g2_11, g2_12, g2_13, g2_14, g2_15, g2_16, g2_17, g2_18, g2_19, g2_20, g2_21, g2_22, g2_23, g2_24, g2_25, g2_26, g2_27, g2_28, g2_29, g2_30, g2_31, g2_32, g2_33, g2_34, g2_35, g2_36, g2_37, g2_38, g2_39, g2_40, g3_1, g3_2, g3_3, g3_4, g3_5, g3_6, g3_7, g3_8, g3_9, g3_10, g3_11, g3_12, g3_13, g3_14, g3_15, g3_16, g3_17, g3_18, g3_19, g3_20, g3_21, g3_22, g3_23, g3_24, g3_25, g3_26, g3_27, g3_28, g3_29, g3_30, g3_31, g3_32, g3_33, g3_34, g3_35, g3_36, g3_37, g3_38, g3_39, g3_40, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, bl_node_0, bl_node_1, bl_node_2, bl_node_3, bl_node_4, bl_node_5, bl_node_6, bl_node_7, bl_node_8, bl_node_9, bl_node_10, bl_node_11, bl_node_5, bl_node_13, bl_node_14, bl_node_15, bl_node_16, bl_node_17, bl_node_18, bl_node_19, bl_node_15, bl_node_21, bl_node_22, bl_node_23, bl_node_24, bl_node_25, bl_node_26, bl_node_27, bl_node_28, bl_node_29, bl_node_30, bl_node_31, bl_node_32, bl_node_33, bl_node_34, bl_node_35, bl_node_36, bl_node_37, bl_node_38, bl_node_39, bl_node_40, bl_node_41, bl_node_42, bl_node_43, bl_node_44, bl_node_45, bl_node_46, bl_node_47, bl_node_48, bl_node_49, bl_node_50, bl_node_51, bl_node_52, bl_node_53, bl_node_54, bl_node_55, bl_node_56, bl_node_57, bl_node_58, bl_node_59, bl_node_60, bl_node_61, bl_node_62, bl_node_63, bl_node_64, bl_node_65, bl_node_66, bl_node_67, bl_node_68, bl_node_69, bl_node_70, bl_node_71, bl_node_72, bl_node_73, bl_node_74, bl_node_75, bl_node_76, bl_node_77, bl_node_78, bl_node_79, bl_node_80, bl_node_81, bl_node_82, bl_node_83, bl_node_84, bl_node_85, bl_node_86, bl_node_87, bl_node_88, bl_node_89, bl_node_90, bl_node_91, bl_node_92, bl_node_93, bl_node_94, bl_node_95, bl_node_96, bl_node_97, bl_node_98, bl_node_99, bl_node_100, bl_node_101, bl_node_102, bl_node_103, bl_node_104, bl_node_105, bl_node_106, bl_node_107, bl_node_108, bl_node_109, bl_node_110, bl_node_111, bl_node_112, bl_node_113, bl_node_114, bl_node_115, bl_node_116, bl_node_117, bl_node_118, bl_node_119, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="co">#&gt; 3 g1_1, g1_2, g1_3, g1_4, g1_5, g1_6, g1_7, g1_8, g1_9, g1_10, g1_11, g1_12, g1_13, g1_14, g1_15, g1_16, g1_17, g1_18, g1_19, g1_20, g1_21, g1_22, g1_23, g1_24, g1_25, g1_26, g1_27, g1_28, g1_29, g1_30, g1_31, g1_32, g1_33, g1_34, g1_35, g1_36, g1_37, g1_38, g1_39, g1_40, g2_1, g2_2, g2_3, g2_4, g2_5, g2_6, g2_7, g2_8, g2_9, g2_10, g2_11, g2_12, g2_13, g2_14, g2_15, g2_16, g2_17, g2_18, g2_19, g2_20, g2_21, g2_22, g2_23, g2_24, g2_25, g2_26, g2_27, g2_28, g2_29, g2_30, g2_31, g2_32, g2_33, g2_34, g2_35, g2_36, g2_37, g2_38, g2_39, g2_40, g3_1, g3_2, g3_3, g3_4, g3_5, g3_6, g3_7, g3_8, g3_9, g3_10, g3_11, g3_12, g3_13, g3_14, g3_15, g3_16, g3_17, g3_18, g3_19, g3_20, g3_21, g3_22, g3_23, g3_24, g3_25, g3_26, g3_27, g3_28, g3_29, g3_30, g3_31, g3_32, g3_33, g3_34, g3_35, g3_36, g3_37, g3_38, g3_39, g3_40, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, bl_node_0, bl_node_1, bl_node_2, bl_node_3, bl_node_4, bl_node_5, bl_node_6, bl_node_7, bl_node_8, bl_node_9, bl_node_10, bl_node_11, bl_node_5, bl_node_13, bl_node_14, bl_node_15, bl_node_16, bl_node_17, bl_node_18, bl_node_19, bl_node_15, bl_node_21, bl_node_22, bl_node_23, bl_node_24, bl_node_25, bl_node_26, bl_node_27, bl_node_28, bl_node_29, bl_node_30, bl_node_31, bl_node_32, bl_node_33, bl_node_34, bl_node_38, bl_node_36, bl_node_37, bl_node_38, bl_node_39, bl_node_40, bl_node_41, bl_node_42, bl_node_43, bl_node_44, bl_node_45, bl_node_46, bl_node_47, bl_node_48, bl_node_49, bl_node_50, bl_node_51, bl_node_52, bl_node_53, bl_node_54, bl_node_55, bl_node_56, bl_node_57, bl_node_58, bl_node_59, bl_node_60, bl_node_61, bl_node_62, bl_node_63, bl_node_64, bl_node_65, bl_node_66, bl_node_67, bl_node_68, bl_node_69, bl_node_70, bl_node_71, bl_node_72, bl_node_73, bl_node_74, bl_node_75, bl_node_76, bl_node_77, bl_node_78, bl_node_79, bl_node_80, bl_node_81, bl_node_82, bl_node_83, bl_node_84, bl_node_85, bl_node_86, bl_node_87, bl_node_88, bl_node_89, bl_node_90, bl_node_91, bl_node_92, bl_node_93, bl_node_94, bl_node_95, bl_node_96, bl_node_97, bl_node_98, bl_node_99, bl_node_100, bl_node_101, bl_node_102, bl_node_103, bl_node_104, bl_node_105, bl_node_106, bl_node_107, bl_node_108, bl_node_109, bl_node_110, bl_node_111, bl_node_112, bl_node_113, bl_node_114, bl_node_115, bl_node_116, bl_node_117, bl_node_118, bl_node_119, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="co">#&gt; 4 g1_1, g1_2, g1_3, g1_4, g1_5, g1_6, g1_7, g1_8, g1_9, g1_10, g1_11, g1_12, g1_13, g1_14, g1_15, g1_16, g1_17, g1_18, g1_19, g1_20, g1_21, g1_22, g1_23, g1_24, g1_25, g1_26, g1_27, g1_28, g1_29, g1_30, g1_31, g1_32, g1_33, g1_34, g1_35, g1_36, g1_37, g1_38, g1_39, g1_40, g2_1, g2_2, g2_3, g2_4, g2_5, g2_6, g2_7, g2_8, g2_9, g2_10, g2_11, g2_12, g2_13, g2_14, g2_15, g2_16, g2_17, g2_18, g2_19, g2_20, g2_21, g2_22, g2_23, g2_24, g2_25, g2_26, g2_27, g2_28, g2_29, g2_30, g2_31, g2_32, g2_33, g2_34, g2_35, g2_36, g2_37, g2_38, g2_39, g2_40, g3_1, g3_2, g3_3, g3_4, g3_5, g3_6, g3_7, g3_8, g3_9, g3_10, g3_11, g3_12, g3_13, g3_14, g3_15, g3_16, g3_17, g3_18, g3_19, g3_20, g3_21, g3_22, g3_23, g3_24, g3_25, g3_26, g3_27, g3_28, g3_29, g3_30, g3_31, g3_32, g3_33, g3_34, g3_35, g3_36, g3_37, g3_38, g3_39, g3_40, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, bl_node_0, bl_node_1, bl_node_2, bl_node_3, bl_node_4, bl_node_5, bl_node_6, bl_node_7, bl_node_8, bl_node_9, bl_node_10, bl_node_11, bl_node_5, bl_node_13, bl_node_14, bl_node_15, bl_node_16, bl_node_17, bl_node_18, bl_node_19, bl_node_15, bl_node_21, bl_node_22, bl_node_23, bl_node_24, bl_node_25, bl_node_26, bl_node_27, bl_node_28, bl_node_29, bl_node_30, bl_node_31, bl_node_32, bl_node_33, bl_node_34, bl_node_38, bl_node_22, bl_node_37, bl_node_38, bl_node_39, bl_node_40, bl_node_41, bl_node_42, bl_node_43, bl_node_44, bl_node_45, bl_node_46, bl_node_47, bl_node_48, bl_node_49, bl_node_50, bl_node_51, bl_node_52, bl_node_53, bl_node_54, bl_node_55, bl_node_56, bl_node_57, bl_node_58, bl_node_59, bl_node_60, bl_node_61, bl_node_62, bl_node_63, bl_node_64, bl_node_65, bl_node_66, bl_node_67, bl_node_68, bl_node_69, bl_node_70, bl_node_71, bl_node_72, bl_node_73, bl_node_74, bl_node_75, bl_node_76, bl_node_77, bl_node_78, bl_node_79, bl_node_80, bl_node_81, bl_node_82, bl_node_83, bl_node_84, bl_node_85, bl_node_86, bl_node_87, bl_node_88, bl_node_89, bl_node_90, bl_node_91, bl_node_92, bl_node_93, bl_node_94, bl_node_95, bl_node_96, bl_node_97, bl_node_98, bl_node_99, bl_node_100, bl_node_101, bl_node_102, bl_node_103, bl_node_104, bl_node_105, bl_node_106, bl_node_107, bl_node_108, bl_node_109, bl_node_110, bl_node_111, bl_node_112, bl_node_113, bl_node_114, bl_node_115, bl_node_116, bl_node_117, bl_node_118, bl_node_119, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="co">#&gt; 5 g1_1, g1_2, g1_3, g1_4, g1_5, g1_6, g1_7, g1_8, g1_9, g1_10, g1_11, g1_12, g1_13, g1_14, g1_15, g1_16, g1_17, g1_18, g1_19, g1_20, g1_21, g1_22, g1_23, g1_24, g1_25, g1_26, g1_27, g1_28, g1_29, g1_30, g1_31, g1_32, g1_33, g1_34, g1_35, g1_36, g1_37, g1_38, g1_39, g1_40, g2_1, g2_2, g2_3, g2_4, g2_5, g2_6, g2_7, g2_8, g2_9, g2_10, g2_11, g2_12, g2_13, g2_14, g2_15, g2_16, g2_17, g2_18, g2_19, g2_20, g2_21, g2_22, g2_23, g2_24, g2_25, g2_26, g2_27, g2_28, g2_29, g2_30, g2_31, g2_32, g2_33, g2_34, g2_35, g2_36, g2_37, g2_38, g2_39, g2_40, g3_1, g3_2, g3_3, g3_4, g3_5, g3_6, g3_7, g3_8, g3_9, g3_10, g3_11, g3_12, g3_13, g3_14, g3_15, g3_16, g3_17, g3_18, g3_19, g3_20, g3_21, g3_22, g3_23, g3_24, g3_25, g3_26, g3_27, g3_28, g3_29, g3_30, g3_31, g3_32, g3_33, g3_34, g3_35, g3_36, g3_37, g3_38, g3_39, g3_40, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, bl_node_0, bl_node_1, bl_node_2, bl_node_3, bl_node_4, bl_node_5, bl_node_6, bl_node_7, bl_node_8, bl_node_9, bl_node_10, bl_node_11, bl_node_5, bl_node_13, bl_node_14, bl_node_15, bl_node_16, bl_node_17, bl_node_18, bl_node_19, bl_node_15, bl_node_21, bl_node_22, bl_node_23, bl_node_24, bl_node_25, bl_node_26, bl_node_27, bl_node_28, bl_node_29, bl_node_30, bl_node_31, bl_node_22, bl_node_33, bl_node_34, bl_node_38, bl_node_22, bl_node_37, bl_node_38, bl_node_39, bl_node_40, bl_node_41, bl_node_42, bl_node_43, bl_node_44, bl_node_45, bl_node_46, bl_node_47, bl_node_48, bl_node_49, bl_node_50, bl_node_51, bl_node_52, bl_node_53, bl_node_54, bl_node_55, bl_node_56, bl_node_57, bl_node_58, bl_node_59, bl_node_60, bl_node_61, bl_node_62, bl_node_63, bl_node_64, bl_node_65, bl_node_66, bl_node_67, bl_node_68, bl_node_69, bl_node_70, bl_node_71, bl_node_72, bl_node_73, bl_node_74, bl_node_75, bl_node_76, bl_node_77, bl_node_78, bl_node_79, bl_node_80, bl_node_81, bl_node_82, bl_node_83, bl_node_84, bl_node_85, bl_node_86, bl_node_87, bl_node_88, bl_node_89, bl_node_90, bl_node_91, bl_node_92, bl_node_93, bl_node_94, bl_node_95, bl_node_96, bl_node_97, bl_node_98, bl_node_99, bl_node_100, bl_node_101, bl_node_102, bl_node_103, bl_node_104, bl_node_105, bl_node_106, bl_node_107, bl_node_108, bl_node_109, bl_node_110, bl_node_111, bl_node_112, bl_node_113, bl_node_114, bl_node_115, bl_node_116, bl_node_117, bl_node_118, bl_node_119, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="co">#&gt; 6 g1_1, g1_2, g1_3, g1_4, g1_5, g1_6, g1_7, g1_8, g1_9, g1_10, g1_11, g1_12, g1_13, g1_14, g1_15, g1_16, g1_17, g1_18, g1_19, g1_20, g1_21, g1_22, g1_23, g1_24, g1_25, g1_26, g1_27, g1_28, g1_29, g1_30, g1_31, g1_32, g1_33, g1_34, g1_35, g1_36, g1_37, g1_38, g1_39, g1_40, g2_1, g2_2, g2_3, g2_4, g2_5, g2_6, g2_7, g2_8, g2_9, g2_10, g2_11, g2_12, g2_13, g2_14, g2_15, g2_16, g2_17, g2_18, g2_19, g2_20, g2_21, g2_22, g2_23, g2_24, g2_25, g2_26, g2_27, g2_28, g2_29, g2_30, g2_31, g2_32, g2_33, g2_34, g2_35, g2_36, g2_37, g2_38, g2_39, g2_40, g3_1, g3_2, g3_3, g3_4, g3_5, g3_6, g3_7, g3_8, g3_9, g3_10, g3_11, g3_12, g3_13, g3_14, g3_15, g3_16, g3_17, g3_18, g3_19, g3_20, g3_21, g3_22, g3_23, g3_24, g3_25, g3_26, g3_27, g3_28, g3_29, g3_30, g3_31, g3_32, g3_33, g3_34, g3_35, g3_36, g3_37, g3_38, g3_39, g3_40, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, node, bl_node_0, bl_node_1, bl_node_2, bl_node_3, bl_node_4, bl_node_5, bl_node_6, bl_node_7, bl_node_8, bl_node_9, bl_node_10, bl_node_11, bl_node_5, bl_node_13, bl_node_14, bl_node_15, bl_node_16, bl_node_17, bl_node_18, bl_node_19, bl_node_15, bl_node_21, bl_node_22, bl_node_23, bl_node_24, bl_node_25, bl_node_26, bl_node_27, bl_node_28, bl_node_29, bl_node_30, bl_node_31, bl_node_22, bl_node_33, bl_node_34, bl_node_38, bl_node_22, bl_node_19, bl_node_38, bl_node_39, bl_node_40, bl_node_41, bl_node_42, bl_node_43, bl_node_44, bl_node_45, bl_node_46, bl_node_47, bl_node_48, bl_node_49, bl_node_50, bl_node_51, bl_node_52, bl_node_53, bl_node_54, bl_node_55, bl_node_56, bl_node_57, bl_node_58, bl_node_59, bl_node_60, bl_node_61, bl_node_62, bl_node_63, bl_node_64, bl_node_65, bl_node_66, bl_node_67, bl_node_68, bl_node_69, bl_node_70, bl_node_71, bl_node_72, bl_node_73, bl_node_74, bl_node_75, bl_node_76, bl_node_77, bl_node_78, bl_node_79, bl_node_80, bl_node_81, bl_node_82, bl_node_83, bl_node_84, bl_node_85, bl_node_86, bl_node_87, bl_node_88, bl_node_89, bl_node_90, bl_node_91, bl_node_92, bl_node_93, bl_node_94, bl_node_95, bl_node_96, bl_node_97, bl_node_98, bl_node_99, bl_node_100, bl_node_101, bl_node_102, bl_node_103, bl_node_104, bl_node_105, bl_node_106, bl_node_107, bl_node_108, bl_node_109, bl_node_110, bl_node_111, bl_node_112, bl_node_113, bl_node_114, bl_node_115, bl_node_116, bl_node_117, bl_node_118, bl_node_119, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0</span></span></code></pre></div>
<p>The results of the collapse function are a column with entropy of the model at a given state, entropy delta caused by that move, and the number of groups in the model at that state. We can plot these using the included <code><a href="../reference/visualize_collapse_results.html">visualize_collapse_results()</a></code> function to check for patterns.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw"><a href="../reference/visualize_collapse_results.html">visualize_collapse_results</a></span>(network)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/plot_default_collapse-1.png" width="576"></p>
<p>Right away we see a sharp leveling off of the entropy/ entropy delta after we get to the true number of groups. This shows that the model effectively found the true partitioning and then as soon as it was forced to merge non-member nodes together the performance got much worse.</p>
</div>
<div id="deciding-the-end-partition" class="section level3">
<h3 class="hasAnchor">
<a href="#deciding-the-end-partition" class="anchor"></a>Deciding the end partition</h3>
<p>While this example may seem simple enough that we could just select the optimal clusters by looking at the graph, we want an automated way to choose the best state that will get us away from guessing. There are a few included heuristics in the package (and you can build your own).</p>
<p>These heuristics try to guess the point where the model found the best partitioning by looking at the trends in the entropy delta value. The one that seems to work best is called “delta_ratio”. it looks at the ratio of the average entropy delta pre and post a given location to find the point where there is the largest divergence, which usually indicates when the model has stopped being able to fill true groups into unique inferred groups.</p>
<p>Any of these heuristics can be run on the entropy value instead of the entropy_delta just by setting the argument <code>use_entropy_value_for_score = TRUE</code>.</p>
<div id="visualizing-collapse-results-scores" class="section level4">
<h4 class="hasAnchor">
<a href="#visualizing-collapse-results-scores" class="anchor"></a>Visualizing Collapse Results Scores</h4>
<p>We can check out what a given heuristic looks like on our data by simply telling the <code><a href="../reference/visualize_collapse_results.html">visualize_collapse_results()</a></code> function which one we want.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>axis_limits &lt;-<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span>(<span class="dv">0</span>,<span class="dv">20</span>)</span>
<span id="cb7-2"><a href="#cb7-2"></a>true_num_clusters_line &lt;-<span class="st"> </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span>(<span class="dt">xintercept =</span> n_blocks, <span class="dt">color =</span> <span class="st">'orangered'</span>)</span>
<span id="cb7-3"><a href="#cb7-3"></a></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="kw"><a href="../reference/visualize_collapse_results.html">visualize_collapse_results</a></span>(network, <span class="dt">heuristic =</span> <span class="st">"delta_ratio"</span>) <span class="op">+</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="st">  </span>axis_limits <span class="op">+</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="st">  </span>true_num_clusters_line <span class="op">+</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Delta ratio heuristic score"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/delta-heuristic-score-1.png" width="576"></p>
<p>So we see that the true number of clusters corresponds to the highest heuristic score, we can use this to automatically select our best grouping. First let’s look at the other heuristic options.</p>
<p><strong>Non-linear least-squares residual</strong></p>
<p>This heueristic fits a non-linear regression model to the entropy as predicted by the number of groups. The equation it attempts to fit is <span class="math inline">\(\text{entropy} \approx \beta_0 + \beta_1 \log(\text{n_blocks})\)</span>. This is based on the expected decay of entropy for a model with no true structure. Once this equation is fit each points residual from the fit is recorded. The point that is the farthest below the expected value according to the model is considered the ‘best’ fit. This is fit with <code>heuristic = 'nls_residual'</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw"><a href="../reference/visualize_collapse_results.html">visualize_collapse_results</a></span>(network, <span class="dt">heuristic =</span> <span class="st">"nls_residual"</span>) <span class="op">+</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="st">  </span>axis_limits <span class="op">+</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="st">  </span>true_num_clusters_line <span class="op">+</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"NLS residual heuristic score"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/nls-score-1.png" width="576"></p>
<p><strong>Deviation from rolling mean</strong></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw"><a href="../reference/visualize_collapse_results.html">visualize_collapse_results</a></span>(network, <span class="dt">heuristic =</span> <span class="st">"dev_from_rolling_mean"</span>) <span class="op">+</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">  </span>axis_limits <span class="op">+</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span>true_num_clusters_line <span class="op">+</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Deviation from rolling mean"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/dev-from-rolling-score-1.png" width="576"></p>
<p>The deviation from the rolling mean function works similar to the NLS fit but uses a non-parametric smoother in a windowed mean that averages the last three values.</p>
</div>
<div id="choosing" class="section level4">
<h4 class="hasAnchor">
<a href="#choosing" class="anchor"></a>Choosing</h4>
<p>The function <code><a href="../reference/choose_best_collapse_state.html">choose_best_collapse_state()</a></code> will take a collapse results object and your model and use your heuristic of choice to find the best partitioning and then set the model to that. The same heuristics work for the <code><a href="../reference/visualize_collapse_results.html">visualize_collapse_results()</a></code> and <code><a href="../reference/choose_best_collapse_state.html">choose_best_collapse_state()</a></code> functions. Lets choose our results using the deviation from rolling mean hueristic…</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>network &lt;-<span class="st"> </span>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">  </span><span class="kw"><a href="../reference/choose_best_collapse_state.html">choose_best_collapse_state</a></span>(<span class="dt">heuristic =</span> <span class="st">"delta_ratio"</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>)</span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#&gt; Choosing collapse with 3 blocks and an entropy of 2.6062.</span></span></code></pre></div>
<p>So, as expected, the chosen best fit is the correct <code>n_blocks</code> blocks.</p>
</div>
</div>
<div id="investigating-results" class="section level3">
<h3 class="hasAnchor">
<a href="#investigating-results" class="anchor"></a>Investigating Results</h3>
<p>Since we have the true groups for our nodes we can check to see how well the merging did. To do that we just need to merge our results and the raw network data and look at the contingency table of truth to inferred groups.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>state_to_truth_table &lt;-<span class="st"> </span><span class="cf">function</span>(net){</span>
<span id="cb11-2"><a href="#cb11-2"></a>  <span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">right_join</a></span>(<span class="kw"><a href="../reference/state.html">state</a></span>(net),</span>
<span id="cb11-3"><a href="#cb11-3"></a>             net<span class="op">$</span>nodes,</span>
<span id="cb11-4"><a href="#cb11-4"></a>             <span class="dt">by =</span> <span class="st">'id'</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(level <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">    </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">inferred =</span> parent) <span class="op">%&gt;%</span><span class="st"> </span>{</span>
<span id="cb11-7"><a href="#cb11-7"></a>      <span class="kw"><a href="https://rdrr.io/r/base/table.html">table</a></span>(.<span class="op">$</span>inferred, .<span class="op">$</span>block)</span>
<span id="cb11-8"><a href="#cb11-8"></a>    }</span>
<span id="cb11-9"><a href="#cb11-9"></a>}</span>
<span id="cb11-10"><a href="#cb11-10"></a></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="kw">state_to_truth_table</span>(network)</span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt;             </span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co">#&gt;              g1 g2 g3</span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co">#&gt;   bl_node_18 40  0  0</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="co">#&gt;   bl_node_42  0 40  0</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="co">#&gt;   bl_node_93  0  0 40</span></span></code></pre></div>
<p>So we can see that the merging algorithm perfectly separated our nodes into their true groups.</p>
</div>
<div id="allowing-for-node-shuffling" class="section level3">
<h3 class="hasAnchor">
<a href="#allowing-for-node-shuffling" class="anchor"></a>Allowing for node shuffling</h3>
<p>Sometimes if we were worried that the model may be making bad merges early on that manifest in poor performance for smaller groups we may want to let the collapsing allow the nodes to find their preferred locations within each collapse. To do this we simply pause the collapsing and run a few mcmc sweeps to let the nodes find their natural resting place. This can help if a node or two accidentally got merged into an incorrect group earlier in the collapse.</p>
<p>To enable this shuffing we simply set the argument <code>num_mcmc_sweeps</code> to a value greater than <code>0</code>.</p>
<p>This will cause the algorithm to slow down a good bit because every each MCMC sweep move proposal takes O(N) (N = num nodes) time to complete.</p>
<p>Let’s try our above merging run with 5 MCMC sweeps after each step.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>network &lt;-<span class="st"> </span>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="st">  </span><span class="kw"><a href="../reference/collapse_blocks.html">collapse_blocks</a></span>(<span class="dt">sigma =</span> <span class="fl">0.9</span>, </span>
<span id="cb12-3"><a href="#cb12-3"></a>                  <span class="dt">num_mcmc_sweeps =</span> <span class="dv">3</span>,</span>
<span id="cb12-4"><a href="#cb12-4"></a>                  <span class="dt">report_all_steps =</span> <span class="ot">TRUE</span>)</span>
<span id="cb12-5"><a href="#cb12-5"></a></span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="kw"><a href="../reference/visualize_collapse_results.html">visualize_collapse_results</a></span>(network, <span class="dt">heuristic =</span> <span class="st">'dev_from_rolling_mean'</span>) <span class="op">+</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="st">  </span>axis_limits <span class="op">+</span></span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="st">  </span>true_num_clusters_line <span class="op">+</span></span>
<span id="cb12-9"><a href="#cb12-9"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"num_mcmc_sweeps = 10"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/collapse_w_shuffle-1.png" width="576"></p>
<p>Now that we have allowed node shuffling the nice monotonicly decreasing entropy as the number of groups increases has gone away because our mcmc sweeps have the potential to improve the model fit more than the previous merge harmed it. We still however see a strong indicator of where our true number of blocks is. Let’s select that value and see how the model performed.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">  </span><span class="kw"><a href="../reference/choose_best_collapse_state.html">choose_best_collapse_state</a></span>(<span class="dt">heuristic =</span> <span class="st">"dev_from_rolling_mean"</span>, <span class="dt">verbose =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span><span class="kw">state_to_truth_table</span>()</span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="co">#&gt; Choosing collapse with 3 blocks and an entropy of 0.6817.</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&gt;              </span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">#&gt;               g1 g2 g3</span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&gt;   bl_node_128 40  0  0</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#&gt;   bl_node_174  0 40  0</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co">#&gt;   bl_node_210  0  0 40</span></span></code></pre></div>
<p>After adding the sweeps we again get a perfect collapsing into the <code>n_block</code> generating blocks.</p>
</div>
</div>
<div id="raising-sigma" class="section level2">
<h2 class="hasAnchor">
<a href="#raising-sigma" class="anchor"></a>Raising sigma</h2>
<p>One problem with these runs that collapse one group at a time is they are slow, when we add in MCMC sweeps they can get even slower. One way of dealing with this is the parameter <code>sigma</code>.</p>
<p><code>sigma</code> controls the rate the model is collapsed. A slower (and lower) value will allow the model to explore more intermediate steps and make less drastic jumps between.</p>
<p>We can see how <code>sigma</code> effects the speed of the collapse by looking at the total number of steps needed to fully collapse a network down to one remaining group by the total number of nodes in the network.</p>
<p><img src="agglomerative_merging_files/figure-html/steps_needed_to_collapse-1.png" width="576"></p>
<p>We can see that at after around <code>sigma = 1.3</code> the algorithm takes very few steps to collapse the network even as the network gets large.</p>
<p>If we pin the network size at a constant (here 150) we can see the path of collapsing in terms of groups remaining for a variety of sigmas…</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">1.1</span>), <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">2.5</span>), <span class="dt">length.out =</span> <span class="dv">6</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="st">  </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span>(<span class="cf">function</span>(sigma, <span class="dt">starting_num =</span> <span class="dv">150</span>, <span class="dt">num_steps =</span> <span class="dv">15</span>){</span>
<span id="cb14-3"><a href="#cb14-3"></a>    steps &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span>(num_steps<span class="dv">-1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">      </span><span class="kw"><a href="https://purrr.tidyverse.org/reference/reduce.html">reduce</a></span>(<span class="cf">function</span>(group_nums, i){</span>
<span id="cb14-5"><a href="#cb14-5"></a>        curr_n_blocks &lt;-<span class="st"> </span>group_nums[i]</span>
<span id="cb14-6"><a href="#cb14-6"></a>        merges_to_make &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(curr_n_blocks<span class="op">*</span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>(<span class="dv">1</span><span class="op">/</span>sigma))))</span>
<span id="cb14-7"><a href="#cb14-7"></a>        <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(group_nums, <span class="kw"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(curr_n_blocks <span class="op">-</span><span class="st"> </span>merges_to_make, <span class="dv">1</span>))</span>
<span id="cb14-8"><a href="#cb14-8"></a>      },</span>
<span id="cb14-9"><a href="#cb14-9"></a>      <span class="dt">.init =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(starting_num))</span>
<span id="cb14-10"><a href="#cb14-10"></a>    </span>
<span id="cb14-11"><a href="#cb14-11"></a>    <span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">tibble</a></span>(</span>
<span id="cb14-12"><a href="#cb14-12"></a>      <span class="dt">size =</span> steps, </span>
<span id="cb14-13"><a href="#cb14-13"></a>      <span class="dt">sigma =</span> <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(sigma, <span class="dv">3</span>), </span>
<span id="cb14-14"><a href="#cb14-14"></a>      <span class="dt">step =</span> <span class="dv">1</span><span class="op">:</span>num_steps</span>
<span id="cb14-15"><a href="#cb14-15"></a>    )</span>
<span id="cb14-16"><a href="#cb14-16"></a>  }) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> step, <span class="dt">y =</span> size)) <span class="op">+</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>() <span class="op">+</span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(<span class="op">~</span>sigma) <span class="op">+</span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="dt">title =</span> <span class="st">"Number of clusters remaining by merge step for different sigma values"</span>,</span>
<span id="cb14-21"><a href="#cb14-21"></a>       <span class="dt">y =</span> <span class="st">"Number of clusters remaining"</span>,</span>
<span id="cb14-22"><a href="#cb14-22"></a>       <span class="dt">x =</span> <span class="st">"Step Number"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/merge_traces-1.png" width="576"></p>
<p>Again we see that the model collapses very quickly at values of <code>sigma &gt; 1.5</code>.</p>
<p>We can see that with larger sigma values we get very rapid convergence to our desired model size. In theory this could cause issues like follows:</p>
<p>There are four groups in model (<code>{a,b,c,d}</code>). Groups <code>a</code> and <code>b</code> may be close to eachother and group <code>c</code> may be closer to <code>b</code> than it is do <code>d</code>. If we force two merges in a given step, <code>a</code>, and <code>b</code>, may be merged together and then, because those groups are merged and <code>c</code> is now left to merge with only <code>d</code>, which it does, forgoing the more optimal merging of <code>a-&gt;b-&gt;c</code>, <code>d</code>. In practive however, this scenario tends to not be an issue.</p>
<p>Let’s try setting sigma to <code>1.5</code> and seeing how both the collapse performs and how long it takes compared to an exhaustive collapse.</p>
<p>First time the normal exhaustive collapse…</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>full_collapse_time &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="kw"><a href="../reference/collapse_blocks.html">collapse_blocks</a></span>(network, <span class="dt">sigma =</span> <span class="fl">0.9</span>, <span class="dt">report_all_steps =</span> <span class="ot">TRUE</span>)</span>
<span id="cb15-3"><a href="#cb15-3"></a>})</span>
<span id="cb15-4"><a href="#cb15-4"></a></span>
<span id="cb15-5"><a href="#cb15-5"></a>full_collapse_time</span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="co">#&gt;    user  system elapsed </span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="co">#&gt;   1.028   0.001   1.031</span></span></code></pre></div>
<p>Now raise sigma to 1.4 and time…</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>raised_sigma_collapse_time &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span>({</span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="kw"><a href="../reference/collapse_blocks.html">collapse_blocks</a></span>(network, <span class="dt">sigma =</span> <span class="fl">1.4</span>, <span class="dt">report_all_steps =</span> <span class="ot">TRUE</span>)</span>
<span id="cb16-3"><a href="#cb16-3"></a>})</span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a>raised_sigma_collapse_time</span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="co">#&gt;    user  system elapsed </span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="co">#&gt;   0.072   0.000   0.073</span></span></code></pre></div>
<p>Just by increasing sigma to 1.4 we have sped up the collapsing by 14.28 times.</p>
<p>Speed isn’t important if the model isnt working properly, however. So let’s see how the collapse worked.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>network &lt;-<span class="st"> </span><span class="kw"><a href="../reference/collapse_blocks.html">collapse_blocks</a></span>(network, <span class="dt">sigma =</span> <span class="fl">1.4</span>, <span class="dt">report_all_steps =</span> <span class="ot">TRUE</span>)</span>
<span id="cb17-2"><a href="#cb17-2"></a></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="kw"><a href="../reference/visualize_collapse_results.html">visualize_collapse_results</a></span>(network, <span class="dt">heuristic =</span> <span class="st">"dev_from_rolling_mean"</span>) <span class="op">+</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="st">  </span>axis_limits <span class="op">+</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="st">  </span>true_num_clusters_line <span class="op">+</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Collapse with sigma = 1.5"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/visualize-high-sigma-collapse-1.png" width="576"></p>
<p>So even with this speedup we are finding the proper number of clusters. Let’s see if the separation is good.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="st">  </span><span class="kw"><a href="../reference/choose_best_collapse_state.html">choose_best_collapse_state</a></span>(<span class="dt">heuristic =</span> <span class="st">"dev_from_rolling_mean"</span>, </span>
<span id="cb18-3"><a href="#cb18-3"></a>                             <span class="dt">verbose =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="st">  </span><span class="kw">state_to_truth_table</span>()</span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="co">#&gt; Choosing collapse with 3 blocks and an entropy of 14.803.</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="co">#&gt;              </span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="co">#&gt;               g1 g2 g3</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="co">#&gt;   bl_node_518 40  0  0</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="co">#&gt;   bl_node_578  0  0 39</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="co">#&gt;   bl_node_581  0 40  1</span></span></code></pre></div>
<p>So again we are getting extremely good performance. Often a balance between allowing MCMC sweeps and a moderate sigma value will return very good and very fast collapsing results.</p>
</div>
<div id="collapse-runs" class="section level2">
<h2 class="hasAnchor">
<a href="#collapse-runs" class="anchor"></a>Collapse Runs</h2>
<p>So far we have looked at a single run of agglomerative collapsing, but the recomended method in the paper the algorithm was introduced in, <a href="https://arxiv.org/abs/1310.4378">Piexoto 2014</a> is running a seperate collapse for each reasonable number of groups, going from one up to a reasonable stopping point.</p>
<p>Interestingly, due to the speed advantages of the high sigma values, even running seperate collapses for each target group number can be very fast compared to a single merge that looks at the possible group values.</p>
<p>The function <code><a href="../reference/collapse_run.html">collapse_run()</a></code> performs multiple merge runs to different numbers of groups and returns the results of the final merge collapsed together in the same form <code><a href="../reference/collapse_blocks.html">collapse_blocks()</a></code> does with <code>report_all_steps = TRUE</code>.</p>
<p>The only arguments it has that <code><a href="../reference/collapse_blocks.html">collapse_blocks()</a></code> does not are:</p>
<ul>
<li>
<code>num_final_blocks</code>: Array of group numbers that the agglomerative merge should target. E.g. 1:10.</li>
<li>
<code>parallel</code>: Should algorithm be run in parallel to speed up?</li>
</ul>
<p>The parallel argument is particularly valuable as it exploits the fact that each run is independent of the others and thus can be run on seperate threads for significant speedups.</p>
<p>Lets try it on our model scanning from 1-10 groups using sigma of <code>1.5</code> and <code>5</code> mcmc sweeps for each individual collapse.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>network &lt;-<span class="st"> </span>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="st">  </span><span class="kw"><a href="../reference/collapse_run.html">collapse_run</a></span>(<span class="dt">num_final_blocks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, </span>
<span id="cb19-3"><a href="#cb19-3"></a>               <span class="dt">sigma =</span> <span class="fl">1.4</span>,</span>
<span id="cb19-4"><a href="#cb19-4"></a>               <span class="dt">num_mcmc_sweeps =</span> <span class="dv">5</span>,</span>
<span id="cb19-5"><a href="#cb19-5"></a>               <span class="dt">parallel =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p>We can use the same collapse viewing and selection functions as we did previously.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span><span class="kw"><a href="../reference/visualize_collapse_results.html">visualize_collapse_results</a></span>(<span class="dt">heuristic =</span> <span class="st">"nls_residual"</span>) <span class="op">+</span></span>
<span id="cb20-3"><a href="#cb20-3"></a><span class="st">  </span>true_num_clusters_line <span class="op">+</span></span>
<span id="cb20-4"><a href="#cb20-4"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Collapse run"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/visualize-collapse-run-1.png" width="576"></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="st">  </span><span class="kw"><a href="../reference/choose_best_collapse_state.html">choose_best_collapse_state</a></span>(<span class="dt">heuristic =</span> <span class="st">"nls_residual"</span>, </span>
<span id="cb21-3"><a href="#cb21-3"></a>                             <span class="dt">verbose =</span> <span class="ot">TRUE</span>, </span>
<span id="cb21-4"><a href="#cb21-4"></a>                             <span class="dt">use_entropy =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb21-5"><a href="#cb21-5"></a><span class="st">  </span><span class="kw">state_to_truth_table</span>()</span>
<span id="cb21-6"><a href="#cb21-6"></a><span class="co">#&gt; Choosing collapse with 3 blocks and an entropy of 5319.8309.</span></span>
<span id="cb21-7"><a href="#cb21-7"></a><span class="co">#&gt;              </span></span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="co">#&gt;               g1 g2 g3</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="co">#&gt;   bl_node_118  0  0 40</span></span>
<span id="cb21-10"><a href="#cb21-10"></a><span class="co">#&gt;   bl_node_31  40  0  0</span></span>
<span id="cb21-11"><a href="#cb21-11"></a><span class="co">#&gt;   bl_node_46   0 40  0</span></span></code></pre></div>
<p>So we can get MCMC sweeps and moderate sigma values and maintain rather fast collapsing. The nice thing is every end point is targeted directly so the model has the best chance to find the optimal partition for that given number of blocks.</p>
</div>
<div id="effects-of-other-parameters-on-merge-paths" class="section level2">
<h2 class="hasAnchor">
<a href="#effects-of-other-parameters-on-merge-paths" class="anchor"></a>Effects of other parameters on merge paths</h2>
<p>While sigma is the most important parameter for collapse results tuning there are others we can tune. Let’s look at how they effect the results.</p>
</div>
<div id="epsilon-values" class="section level2">
<h2 class="hasAnchor">
<a href="#epsilon-values" class="anchor"></a>Epsilon values</h2>
<p>Epsilon controls how conservative the model is when generating those proposals. As epsilon goes to infinity the moves proposed by the model approach randomness. When epsilon is zero a node can only move to groups that nodes it is connected belong to.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="co"># Get logaritmically spaced epsilon range</span></span>
<span id="cb22-2"><a href="#cb22-2"></a>eps_vals &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="fl">0.1</span>), <span class="kw"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="dv">15</span>), <span class="dt">length.out =</span> <span class="dv">8</span>))</span>
<span id="cb22-3"><a href="#cb22-3"></a></span>
<span id="cb22-4"><a href="#cb22-4"></a>eps_sweep_results &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_dfr</a></span>(</span>
<span id="cb22-5"><a href="#cb22-5"></a>  eps_vals, </span>
<span id="cb22-6"><a href="#cb22-6"></a>  <span class="cf">function</span>(eps){</span>
<span id="cb22-7"><a href="#cb22-7"></a>    <span class="kw"><a href="../reference/collapse_run.html">collapse_run</a></span>(</span>
<span id="cb22-8"><a href="#cb22-8"></a>      network,</span>
<span id="cb22-9"><a href="#cb22-9"></a>      <span class="dt">num_final_blocks =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">8</span>,</span>
<span id="cb22-10"><a href="#cb22-10"></a>      <span class="dt">eps =</span> eps,</span>
<span id="cb22-11"><a href="#cb22-11"></a>      <span class="dt">parallel =</span> <span class="ot">TRUE</span></span>
<span id="cb22-12"><a href="#cb22-12"></a>    ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-13"><a href="#cb22-13"></a><span class="st">      </span><span class="kw"><a href="../reference/get_collapse_results.html">get_collapse_results</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-14"><a href="#cb22-14"></a><span class="st">      </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">epsilon =</span> eps)</span>
<span id="cb22-15"><a href="#cb22-15"></a>  }</span>
<span id="cb22-16"><a href="#cb22-16"></a>)</span>
<span id="cb22-17"><a href="#cb22-17"></a></span>
<span id="cb22-18"><a href="#cb22-18"></a>eps_sweep_results <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb22-19"><a href="#cb22-19"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> n_blocks, <span class="dt">y =</span> entropy, <span class="dt">color =</span> epsilon)) <span class="op">+</span></span>
<span id="cb22-20"><a href="#cb22-20"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">group =</span> epsilon)) <span class="op">+</span></span>
<span id="cb22-21"><a href="#cb22-21"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>() <span class="op">+</span></span>
<span id="cb22-22"><a href="#cb22-22"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_log10</a></span>() <span class="op">+</span></span>
<span id="cb22-23"><a href="#cb22-23"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span>(<span class="st">"Collapse results by epsilon value"</span>)</span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/toggling_epsilon-1.png" width="576"></p>
<p>While the results are close to eachother, there seems to be a trend of higher epsilon values getting better results.</p>
</div>
<div id="looking-at-stability-of-collapse-runs" class="section level2">
<h2 class="hasAnchor">
<a href="#looking-at-stability-of-collapse-runs" class="anchor"></a>Looking at stability of collapse runs</h2>
<p>By simply passing in a groups numbers to check vector with repeates in it we can acccess how stable a given collapse value is for a network. Here we will do five repeats for our network for the range of 2-8 groups.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>num_repeats &lt;-<span class="st"> </span><span class="dv">5</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>group_nums &lt;-<span class="st"> </span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span></span>
<span id="cb23-3"><a href="#cb23-3"></a></span>
<span id="cb23-4"><a href="#cb23-4"></a>network &lt;-<span class="st"> </span>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="st">  </span><span class="kw"><a href="../reference/collapse_run.html">collapse_run</a></span>(</span>
<span id="cb23-6"><a href="#cb23-6"></a>    <span class="dt">num_final_blocks =</span> <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(group_nums, <span class="dt">each =</span> num_repeats),</span>
<span id="cb23-7"><a href="#cb23-7"></a>    <span class="dt">num_mcmc_sweeps =</span> <span class="dv">5</span>,</span>
<span id="cb23-8"><a href="#cb23-8"></a>    <span class="dt">parallel =</span> <span class="ot">TRUE</span></span>
<span id="cb23-9"><a href="#cb23-9"></a>  )</span>
<span id="cb23-10"><a href="#cb23-10"></a></span>
<span id="cb23-11"><a href="#cb23-11"></a>network <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="st">  </span><span class="kw"><a href="../reference/get_collapse_results.html">get_collapse_results</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> n_blocks, <span class="dt">y =</span> entropy)) <span class="op">+</span></span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(<span class="dt">size =</span> <span class="dv">0</span>, <span class="dt">method =</span> <span class="st">'loess'</span>, <span class="dt">span =</span> <span class="fl">0.75</span>, <span class="dt">fill =</span> <span class="st">'steelblue'</span>) <span class="op">+</span></span>
<span id="cb23-15"><a href="#cb23-15"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>, <span class="dt">height =</span> <span class="dv">0</span>, <span class="dt">width =</span> <span class="fl">0.2</span>)  <span class="op">+</span></span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span>(<span class="dt">breaks =</span> group_nums)</span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="co">#&gt; `geom_smooth()` using formula 'y ~ x'</span></span></code></pre></div>
<p><img src="agglomerative_merging_files/figure-html/run_stability-1.png" width="576"></p>
<p>We can see that the results are very stable with relatively minescule for values greater than 3 groups and no variation in the others (indicating they acheived the same partitioning every time).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#setup">Setup</a></li>
      <li><a href="#single-merge-run">Single merge run</a></li>
      <li><a href="#raising-sigma">Raising sigma</a></li>
      <li><a href="#collapse-runs">Collapse Runs</a></li>
      <li><a href="#effects-of-other-parameters-on-merge-paths">Effects of other parameters on merge paths</a></li>
      <li><a href="#epsilon-values">Epsilon values</a></li>
      <li><a href="#looking-at-stability-of-collapse-runs">Looking at stability of collapse runs</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nick Strayer.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
